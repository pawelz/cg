#!/bin/sh

# Copyright © 2010 by Paweł Zuzelski <pawelz@pld-linux.org>
# Author: Paweł Zuzelski <pawelz@pld-linux.org>

# This program is free software. It comes without any warranty, to the extent
# permitted by applicable law. You can redistribute it and/or modify it under
# the terms of the Do What The Fuck You Want To Public License, Version 2, as
# published by Sam Hocevar. See http://sam.zoy.org/wtfpl/COPYING for more
# details.

ROOTRELPATH=$(pwd | sed 's/[^/]\+/../g')/
ROOTRELPATH=${ROOTRELPATH#/}
ROOTRELPATH=${ROOTRELPATH#/}
GIT_DIR=/var/lib/cg
GIT_WORK_TREE="/"
GIT_CEILING_DIRECTORIES=/tmp:/var/spool:/var/cache:/home

# opt parsing
if [ "$(basename $0)" == "vcg" ]; then
	VSERVERMODE=true
	for I in /usr/lib/util-vserver/util-vserver-vars /usr/lib64/util-vserver/util-vserver-vars /usr/local/lib/util-vserver/util-vserver-vars /usr/local/lib64/util-vserver/util-vserver-vars
	do
		if [ -r "$I" ]; then
			. $I
			break
		fi
	done
	if ! [ "$_LIB_FUNCTIONS" ]; then
		echo "ERROR: vcg: util-vserver not found." >&2
		exit 1
	fi
	. $_LIB_FUNCTIONS
	if ! [ "$1" ]; then
		echo "ERROR: vcg: missing vserver name." >&2
		exit 1
	fi
	vserver=$1
	shift
	_pkgSetVarsBase

	GIT_WORK_TREE=$VDIR
	GIT_DIR=$BASEDIR/apps/cg
fi
export GIT_DIR
export GIT_WORK_TREE
export GIT_CEILING_DIRECTORIES
while [ "$1" == "-${1#-}" ]; do
	GITOPTS="$GITOPTS $1"
	shift
done

GITCOMMAND="$1"
shift

while [ "$1" ]; do
	O=${1#/}
	[ "$O" != "$1" ] && O=$ROOTRELPATH$O
	GITCMDOPTS="$GITCMDOPTS $O"
	shift
done

exec git $GITOPTS $GITCOMMAND $GITCMDOPTS
